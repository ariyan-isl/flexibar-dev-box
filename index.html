<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&family=Roboto:wght@100;300;400;500;700;900&family=Open+Sans:wght@300;400;500;600;700;800&family=Lato:wght@100;300;400;700;900&family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <title>Announcement Bar Test</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="skeleton.css" />
  </head>
  <body>
    <script>
      // ============================================================
      // LOAD CONFIGURATION FROM config.json
      // ============================================================

      let CONFIG = null;

      // Font size multipliers relative to base (1rem = 16px)
      const SIZE_CLASSES = {
        small: "size-small",
        normal: "size-normal",
        large: "size-large",
        "very-large": "size-very-large",
      };

      // Load config from JSON file
      async function loadConfig() {
        try {
          const response = await fetch("config.json");
          CONFIG = await response.json();

          // Initialize the bar after config is loaded
          initializeFlexibar();
        } catch (error) {
          console.error("Failed to load config.json:", error);
        }
      }

      // ============================================================
      // HELPER FUNCTIONS
      // ============================================================

      function getBarBackground() {
        if (CONFIG.design.bar.backgroundType === "gradient") {
          return `linear-gradient(${CONFIG.design.bar.gradient.angle}deg, ${CONFIG.design.bar.gradient.color1}, ${CONFIG.design.bar.gradient.color2})`;
        }
        return CONFIG.design.bar.backgroundColor;
      }

      function getBarPositionClass() {
        return CONFIG.design.bar.position || "";
      }

      function getBarAnimationClass() {
        if (
          CONFIG.design.bar.animation &&
          CONFIG.design.bar.animation !== "none"
        ) {
          return CONFIG.design.bar.animation;
        }
        return "";
      }

      function getButtonAnimationClass() {
        if (
          CONFIG.design.button.animation &&
          CONFIG.design.button.animation !== "none"
        ) {
          return CONFIG.design.button.animation;
        }
        return "";
      }

      function handleBarClick(e) {
        if (
          CONFIG.design.bar.clickable.enabled &&
          CONFIG.design.bar.clickable.url
        ) {
          // Don't trigger if clicking on button or link
          if (e.target.closest(".flexibar-button") || e.target.closest("a")) {
            return;
          }
          window.open(
            CONFIG.design.bar.clickable.url,
            CONFIG.design.bar.clickable.openWith
          );
        }
      }

      // ============================================================
      // RENDER FUNCTIONS
      // ============================================================

      function renderBar() {
        const barEl = document.getElementById("flexibar-announcement-bar");
        if (!barEl) return;

        // Apply font size class (default to 'normal' if not set)
        const sizeOption = CONFIG.design.bar.fontSize || "normal";
        const sizeClass = SIZE_CLASSES[sizeOption] || SIZE_CLASSES.normal;

        // Remove any existing size classes and add the new one
        Object.values(SIZE_CLASSES).forEach((cls) =>
          barEl.classList.remove(cls)
        );
        barEl.classList.add(sizeClass);

        // Apply bar styles
        barEl.style.background = getBarBackground();
        barEl.style.padding = `${CONFIG.design.bar.padding}rem`;
        barEl.style.borderWidth = `${CONFIG.design.bar.border.width}rem`;
        barEl.style.borderStyle = CONFIG.design.bar.border.style;
        barEl.style.borderColor = CONFIG.design.bar.border.color;
        barEl.style.borderRadius = `${CONFIG.design.bar.border.radius}rem`;
        barEl.style.cursor = CONFIG.design.bar.clickable.enabled
          ? "pointer"
          : "default";

        // Handle DOM placement for bottom positions
        if (
          CONFIG.design.bar.position === "bottom" ||
          CONFIG.design.bar.position === "sticky-bottom"
        ) {
          document.body.appendChild(barEl);
        } else {
          document.body.insertBefore(barEl, document.body.firstChild);
        }

        // Apply position class
        const positionClass = getBarPositionClass();
        if (positionClass) {
          barEl.classList.add(positionClass);
        }

        // Apply animation class
        const animClass = getBarAnimationClass();
        if (animClass) {
          barEl.classList.add(animClass);
        }

        // Apply alignment for single message mode
        const topRow = barEl.querySelector(".flexibar-content-row");
        if (topRow) {
          if (CONFIG.type === "single") {
            const alignMap = {
              left: "flex-start",
              center: "center",
              right: "flex-end",
            };
            topRow.style.justifyContent =
              alignMap[CONFIG.design.bar.contentAlignment] || "center";
          } else {
            // Reset to default for rolling (or handle mobile/desktop diffs via CSS)
            // For rolling, we usually want it to take full width, but the CSS handles it.
            // We can clear the inline style to let CSS take over.
            topRow.style.justifyContent = "";
          }
        }

        // Add click handler for clickable bar
        if (CONFIG.design.bar.clickable.enabled) {
          barEl.addEventListener("click", handleBarClick);
        }
      }

      function renderMessage() {
        const messageEls = document.querySelectorAll(".message-text");
        messageEls.forEach((el) => {
          el.innerHTML = CONFIG.content.message.title;
          el.style.color = CONFIG.design.message.fontColor;
          // Font size is inherited from the bar's base size
          el.style.fontSize = `var(--flexibar-base-size)`;
          el.style.fontFamily = CONFIG.design.message.fontFamily;
          el.style.fontWeight = CONFIG.design.message.fontWeight;
          el.style.paddingRight = `${CONFIG.scrolling.gap}rem`;
        });
      }

      function renderButton() {
        const buttonEls = document.querySelectorAll(".flexibar-button");
        buttonEls.forEach((el) => {
          if (!CONFIG.button.enabled) {
            el.style.display = "none";
            return;
          }
          el.style.display = "inline-flex";
          el.textContent = CONFIG.content.button.text;
          el.style.color = CONFIG.design.button.textColor;
          el.style.backgroundColor = CONFIG.design.button.backgroundColor;
          el.style.borderRadius = `${CONFIG.design.button.borderRadius}rem`;
          el.style.padding = `${CONFIG.design.button.paddingY}rem ${CONFIG.design.button.paddingX}rem`;
          // Font size is inherited from the bar's base size
          el.style.fontSize = `var(--flexibar-base-size)`;
          el.href = CONFIG.content.button.url;
          el.target = CONFIG.content.button.openWith;

          // Apply animation class
          const animClass = getButtonAnimationClass();
          if (animClass) {
            el.classList.add(animClass);
          }
        });
      }

      function renderCountdown() {
        const desktopCountdown = document.getElementById("countdown-desktop");
        const mobileCountdown = document.getElementById("countdown-mobile");
        const countdownRow = document.querySelector(".flexibar-countdown-row");

        if (!CONFIG.countdown.enabled) {
          if (desktopCountdown) desktopCountdown.style.display = "none";
          // Use setProperty with 'important' to override the CSS media query
          if (countdownRow)
            countdownRow.style.setProperty("display", "none", "important");
          if (mobileCountdown) mobileCountdown.style.display = "none";
          return;
        }

        // Apply styles to both desktop and mobile countdowns
        [desktopCountdown, mobileCountdown].forEach((el) => {
          if (!el) return;
          el.style.fontFamily = CONFIG.design.countdown.fontFamily;
          // Font size is inherited from the bar's base size
          el.style.fontSize = `var(--flexibar-base-size)`;
          el.style.fontWeight = CONFIG.design.countdown.fontWeight;
        });

        // Apply styles to countdown units
        const countdownUnits = document.querySelectorAll(".countdown-unit");
        countdownUnits.forEach((unit) => {
          unit.style.color = CONFIG.design.countdown.textColor;
          unit.style.backgroundColor = CONFIG.design.countdown.backgroundColor;
          unit.style.borderRadius = `${CONFIG.design.countdown.borderRadius}rem`;
          unit.style.padding = `${CONFIG.design.countdown.padding}rem`;
          unit.style.boxShadow = `${CONFIG.design.countdown.shadowColor} 0.125rem 0.25rem 0.3125rem`;
        });
      }

      // ============================================================
      // SCROLLING ANIMATION
      // ============================================================

      function initScrollingMessage() {
        const scrollingContent = document.getElementById(
          "message-scroll-content"
        );
        if (!scrollingContent) return;

        // Reset content to single message first (cleanup clones)
        // We need to preserve at least one message element
        const firstMessage = scrollingContent.querySelector(".message-text");
        if (firstMessage) {
          // Clone the first message to ensure we have a clean copy
          const cleanMessage = firstMessage.cloneNode(true);
          scrollingContent.innerHTML = "";
          scrollingContent.appendChild(cleanMessage);
        }

        const messageEl = scrollingContent.querySelector(".message-text");
        const container = scrollingContent.parentElement;

        // Apply message styles first
        renderMessage();

        // Check for single message type
        if (CONFIG.type === "single") {
          container.style.flex = "0 1 auto";
          container.style.minWidth = "auto";
          scrollingContent.style.animation = "none";
          return;
        }

        // Rolling logic
        container.style.flex = "1";
        container.style.minWidth = "9.375rem";

        // Get the width of a single message
        const messageWidth = messageEl.offsetWidth;
        const containerWidth = container.offsetWidth;

        // Calculate how many copies we need to fill container + one extra for seamless loop
        const copiesNeeded = Math.ceil(containerWidth / messageWidth) + 2;

        // Clone messages to fill the space
        for (let i = 0; i < copiesNeeded; i++) {
          const clone = messageEl.cloneNode(true);
          scrollingContent.appendChild(clone);
        }

        // Create dynamic keyframes
        const styleSheet = document.createElement("style");
        styleSheet.textContent = `
          @keyframes seamless-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-${messageWidth}px); }
          }
        `;
        document.head.appendChild(styleSheet);

        // Apply animation
        const duration = messageWidth / CONFIG.scrolling.speed;
        scrollingContent.style.animation = `seamless-scroll ${duration}s linear infinite`;
      }

      // ============================================================
      // COUNTDOWN TIMER
      // ============================================================

      function runCountdown() {
        if (!CONFIG.countdown.enabled) return;

        const targetDate = new Date(CONFIG.content.countdown.targetDate);

        function updateCountdown() {
          const now = new Date();
          const diff = targetDate - now;

          if (diff <= 0) {
            // Countdown finished
            const elements = ["days", "hours", "minutes", "seconds"];
            elements.forEach((el) => {
              const desktopEl = document.getElementById(
                `countdown-${el}-desktop`
              );
              const mobileEl = document.getElementById(
                `countdown-${el}-mobile`
              );
              if (desktopEl) desktopEl.textContent = "00";
              if (mobileEl) mobileEl.textContent = "00";
            });
            return;
          }

          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor(
            (diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
          );
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);

          // Desktop countdown
          document.getElementById("countdown-days-desktop").textContent =
            String(days).padStart(2, "0");
          document.getElementById("countdown-hours-desktop").textContent =
            String(hours).padStart(2, "0");
          document.getElementById("countdown-minutes-desktop").textContent =
            String(minutes).padStart(2, "0");
          document.getElementById("countdown-seconds-desktop").textContent =
            String(seconds).padStart(2, "0");

          // Mobile countdown
          document.getElementById("countdown-days-mobile").textContent = String(
            days
          ).padStart(2, "0");
          document.getElementById("countdown-hours-mobile").textContent =
            String(hours).padStart(2, "0");
          document.getElementById("countdown-minutes-mobile").textContent =
            String(minutes).padStart(2, "0");
          document.getElementById("countdown-seconds-mobile").textContent =
            String(seconds).padStart(2, "0");
        }

        // Update immediately and then every second
        updateCountdown();
        setInterval(updateCountdown, 1000);
      }

      // ============================================================
      // INITIALIZATION
      // ============================================================

      function initializeFlexibar() {
        renderBar();
        renderButton();
        renderCountdown();
        initScrollingMessage();
        runCountdown();
      }

      // Load config and initialize on DOM ready
      document.addEventListener("DOMContentLoaded", function () {
        loadConfig();
      });
    </script>

    <!-- Flexibar Announcement Bar -->
    <!-- Desktop: Message | Countdown | Button -->
    <!-- Mobile: Message | Button (top), Countdown (centered below) -->
    <div id="flexibar-announcement-bar" class="flexibar-container">
      <!-- Top Row: Message + (Countdown on desktop) + Button -->
      <div class="flexibar-content-row">
        <!-- Scrolling Message Container -->
        <div class="message-container" style="min-width: 150px; flex: 1">
          <div class="message-content" id="message-scroll-content">
            <div class="message-text"></div>
          </div>
        </div>

        <!-- Countdown Component (Desktop only - inline) -->
        <div
          id="countdown-desktop"
          class="countdown-wrapper flexibar-countdown-desktop"
          style="display: flex; align-items: center; flex-shrink: 0"
        >
          <!-- Days Unit -->
          <span
            class="countdown-unit"
            style="text-align: center; margin-left: 3px"
          >
            <span id="countdown-days-desktop" class="countdown-value">00</span>
            <span
              class="countdown-label"
              style="
                font-size: x-small;
                margin-top: -7px;
                display: inline-block;
              "
              >DAYS</span
            >
          </span>
          <span>&nbsp;</span>
          <!-- Hours Unit -->
          <span
            class="countdown-unit"
            style="text-align: center; margin-left: 3px"
          >
            <span id="countdown-hours-desktop" class="countdown-value">00</span>
            <span
              class="countdown-label"
              style="
                font-size: x-small;
                margin-top: -7px;
                display: inline-block;
              "
              >HRS</span
            >
          </span>
          <span>&nbsp;</span>
          <!-- Minutes Unit -->
          <span
            class="countdown-unit"
            style="text-align: center; margin-left: 3px"
          >
            <span id="countdown-minutes-desktop" class="countdown-value"
              >00</span
            >
            <span
              class="countdown-label"
              style="
                font-size: x-small;
                margin-top: -7px;
                display: inline-block;
              "
              >MINS</span
            >
          </span>
          <span>&nbsp;</span>
          <!-- Seconds Unit -->
          <span
            class="countdown-unit"
            style="text-align: center; margin-left: 3px"
          >
            <span id="countdown-seconds-desktop" class="countdown-value"
              >00</span
            >
            <span
              class="countdown-label"
              style="
                font-size: x-small;
                margin-top: -7px;
                display: inline-block;
              "
              >SECS</span
            >
          </span>
        </div>

        <!-- Button Component (always on top row, right side) -->
        <a
          href="#"
          target="_blank"
          class="flexibar-button"
          style="
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            width: max-content;
            text-decoration: none;
            border: none;
            flex-shrink: 0;
          "
        >
          See Deal
        </a>
      </div>

      <!-- Bottom Row: Countdown (Mobile only - centered) -->
      <div class="flexibar-countdown-row">
        <div
          id="countdown-mobile"
          class="countdown-wrapper"
          style="display: flex; align-items: center"
        >
          <!-- Days Unit -->
          <span
            class="countdown-unit"
            style="text-align: center; margin-left: 3px"
          >
            <span id="countdown-days-mobile" class="countdown-value">00</span>
            <span
              class="countdown-label"
              style="
                font-size: x-small;
                margin-top: -7px;
                display: inline-block;
              "
              >DAYS</span
            >
          </span>
          <span>&nbsp;</span>
          <!-- Hours Unit -->
          <span
            class="countdown-unit"
            style="text-align: center; margin-left: 3px"
          >
            <span id="countdown-hours-mobile" class="countdown-value">00</span>
            <span
              class="countdown-label"
              style="
                font-size: x-small;
                margin-top: -7px;
                display: inline-block;
              "
              >HRS</span
            >
          </span>
          <span>&nbsp;</span>
          <!-- Minutes Unit -->
          <span
            class="countdown-unit"
            style="text-align: center; margin-left: 3px"
          >
            <span id="countdown-minutes-mobile" class="countdown-value"
              >00</span
            >
            <span
              class="countdown-label"
              style="
                font-size: x-small;
                margin-top: -7px;
                display: inline-block;
              "
              >MINS</span
            >
          </span>
          <span>&nbsp;</span>
          <!-- Seconds Unit -->
          <span
            class="countdown-unit"
            style="text-align: center; margin-left: 3px"
          >
            <span id="countdown-seconds-mobile" class="countdown-value"
              >00</span
            >
            <span
              class="countdown-label"
              style="
                font-size: x-small;
                margin-top: -7px;
                display: inline-block;
              "
              >SECS</span
            >
          </span>
        </div>
      </div>
    </div>

    <!-- Storefront Skeleton -->
    <div class="storefront-skeleton">
      <div class="skeleton-header">
        <div class="skeleton skeleton-logo"></div>
        <div class="skeleton-nav">
          <div class="skeleton skeleton-nav-item"></div>
          <div class="skeleton skeleton-nav-item"></div>
          <div class="skeleton skeleton-nav-item"></div>
        </div>
        <div class="skeleton-nav">
          <div class="skeleton skeleton-nav-item" style="width: 30px"></div>
          <div class="skeleton skeleton-nav-item" style="width: 30px"></div>
        </div>
      </div>

      <div class="skeleton skeleton-hero"></div>

      <div class="skeleton-grid">
        <!-- Generate 4 product skeletons -->
        <div class="skeleton-product">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text-short"></div>
        </div>
        <div class="skeleton-product">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text-short"></div>
        </div>
        <div class="skeleton-product">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text-short"></div>
        </div>
        <div class="skeleton-product">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text-short"></div>
        </div>
      </div>

      <!-- More content for scrolling -->
      <div
        class="skeleton skeleton-hero"
        style="height: 200px; margin-top: 60px"
      ></div>

      <div class="skeleton-grid">
        <div class="skeleton-product">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text-short"></div>
        </div>
        <div class="skeleton-product">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text-short"></div>
        </div>
        <div class="skeleton-product">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text-short"></div>
        </div>
        <div class="skeleton-product">
          <div class="skeleton skeleton-image"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text-short"></div>
        </div>
      </div>

      <div
        class="skeleton skeleton-hero"
        style="height: 300px; margin-top: 60px"
      ></div>
    </div>
  </body>
</html>
